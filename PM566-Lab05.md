---
title: "Lab05"
author: "Haoran Zhang"
date: "2021/9/24"
output=github_document
---


```r
library(data.table)
```

```
## Warning: package 'data.table' was built under R version 4.0.5
```

```r
library(dplyr)
```

```
## Warning: package 'dplyr' was built under R version 4.0.5
```

```
## 
## Attaching package: 'dplyr'
```

```
## The following objects are masked from 'package:data.table':
## 
##     between, first, last
```

```
## The following objects are masked from 'package:stats':
## 
##     filter, lag
```

```
## The following objects are masked from 'package:base':
## 
##     intersect, setdiff, setequal, union
```

```r
library(dtplyr)
```

```
## Warning: package 'dtplyr' was built under R version 4.0.5
```

## Setup
dat

```r
# Download the data
# Where are we getting the data from
met_url <- "https://github.com/USCbiostats/data-science-data/raw/master/02_met/met_all.gz"
# Downloading the data to a tempfile (so it is destroyed afterwards)
# you can replace this with, for example, your own data:
# tmp <- tempfile(fileext = ".gz")
tmp <- "met.gz"
# We sould be downloading this, ONLY IF this was not downloaded already.
# otherwise is just a waste of time.
if (!file.exists(tmp)) {
  download.file(
    url      = met_url,
    destfile = tmp,
    # method   = "libcurl", timeout = 1000 (you may need this option)
  )
}
dat <- fread(tmp)
head(dat)
```

```
##    USAFID  WBAN year month day hour min  lat      lon elev wind.dir wind.dir.qc
## 1: 690150 93121 2019     8   1    0  56 34.3 -116.166  696      220           5
## 2: 690150 93121 2019     8   1    1  56 34.3 -116.166  696      230           5
## 3: 690150 93121 2019     8   1    2  56 34.3 -116.166  696      230           5
## 4: 690150 93121 2019     8   1    3  56 34.3 -116.166  696      210           5
## 5: 690150 93121 2019     8   1    4  56 34.3 -116.166  696      120           5
## 6: 690150 93121 2019     8   1    5  56 34.3 -116.166  696       NA           9
##    wind.type.code wind.sp wind.sp.qc ceiling.ht ceiling.ht.qc ceiling.ht.method
## 1:              N     5.7          5      22000             5                 9
## 2:              N     8.2          5      22000             5                 9
## 3:              N     6.7          5      22000             5                 9
## 4:              N     5.1          5      22000             5                 9
## 5:              N     2.1          5      22000             5                 9
## 6:              C     0.0          5      22000             5                 9
##    sky.cond vis.dist vis.dist.qc vis.var vis.var.qc temp temp.qc dew.point
## 1:        N    16093           5       N          5 37.2       5      10.6
## 2:        N    16093           5       N          5 35.6       5      10.6
## 3:        N    16093           5       N          5 34.4       5       7.2
## 4:        N    16093           5       N          5 33.3       5       5.0
## 5:        N    16093           5       N          5 32.8       5       5.0
## 6:        N    16093           5       N          5 31.1       5       5.6
##    dew.point.qc atm.press atm.press.qc       rh
## 1:            5    1009.9            5 19.88127
## 2:            5    1010.3            5 21.76098
## 3:            5    1010.6            5 18.48212
## 4:            5    1011.6            5 16.88862
## 5:            5    1012.7            5 17.38410
## 6:            5    1012.7            5 20.01540
```
stations

```r
stations <- fread("isd-history.csv")
stations[, USAF := as.integer(USAF)]
```

```
## Warning in eval(jsub, SDenv, parent.frame()): 强制改变过程中产生了NA
```

```r
# Dealing with NAs and 999999
stations[, USAF   := fifelse(USAF == 999999, NA_integer_, USAF)]
stations[, CTRY   := fifelse(CTRY == "", NA_character_, CTRY)]
stations[, STATE  := fifelse(STATE == "", NA_character_, STATE)]

# Selecting the three relevant columns, and keeping unique records
stations <- unique(stations[, list(USAF, CTRY, STATE)])

# Dropping NAs
stations <- stations[!is.na(USAF)]

# Removing duplicates
stations[, n := 1:.N, by = .(USAF)]
stations <- stations[n == 1,][, n := NULL]
```
Merging the data

```r
met <- merge(
  # Data
  x     = dat,      
  y     = stations, 
  # List of variables to match
  by.x  = "USAFID",
  by.y  = "USAF", 
  # Which obs to keep?
  all.x = TRUE,      
  all.y = FALSE
  )
```


## Question 1: Representative station for the US

```r
station_averages<-met[,.(
  temp=mean(temp,na.rm = TRUE),
  wind.sp=mean(wind.sp,na.rm = TRUE),
  atm.press=mean(atm.press,na.rm = TRUE),
  lat=mean(lat,na.rm = TRUE),
  lon=mean(lon,na.rm = TRUE)
),by="USAFID"]
```


```r
medians<-station_averages[,.(
  temp_50=quantile(temp,probs = 0.5,na.rm = TRUE),
  wind.sp_50=quantile(wind.sp,probs = 0.5,na.rm = TRUE),
  atm.press_50=quantile(atm.press,probs = 0.5,na.rm = TRUE)
)]
medians
```

```
##     temp_50 wind.sp_50 atm.press_50
## 1: 23.68406   2.461838     1014.691
```
Find stations that are closest. (which.min())

```r
station_averages[,temp_dist:=abs(temp-medians$temp_50)]
median_temp_station<-station_averages[order(temp_dist)][1]
```
The median temperature station is 720458.

## Question 2: Representative station per state
First recover state variable by merging

```r
station_averages<-merge(x = station_averages, y = stations,by.x = "USAFID", by.y = "USAF", all.x = TRUE, all.y = FALSE)
station_averages
```

```
##       USAFID     temp  wind.sp atm.press      lat       lon temp_dist CTRY
##    1: 690150 33.18763 3.483560  1010.379 34.29982 -116.1658 9.5035752   US
##    2: 720110 31.22003 2.138348       NaN 30.78400  -98.6620 7.5359677   US
##    3: 720113 23.29317 2.470298       NaN 42.54300  -83.1780 0.3908894   US
##    4: 720120 27.01922 2.504692       NaN 32.21746  -80.6998 3.3351568   US
##    5: 720137 21.88823 1.979335       NaN 41.42500  -88.4190 1.7958292   US
##   ---                                                                     
## 1591: 726777 19.15492 4.673878  1014.299 46.35792 -104.2501 4.5291393   US
## 1592: 726797 18.78980 2.858586  1014.902 45.78795 -111.1600 4.8942607   US
## 1593: 726798 19.47014 4.445783  1014.072 45.69800 -110.4400 4.2139153   US
## 1594: 726810 25.03549 3.039794  1011.730 43.56700 -116.2390 1.3514356   US
## 1595: 726813 23.47809 2.435372  1012.315 43.64963 -116.6331 0.2059716   US
##       STATE
##    1:    CA
##    2:    TX
##    3:    MI
##    4:    SC
##    5:    IL
##   ---      
## 1591:    MT
## 1592:    MT
## 1593:    MT
## 1594:    ID
## 1595:    ID
```

```r
station_averages[, temp_50:=quantile(temp,probs = 0.5,na.rm = TRUE), by=STATE]
station_averages[, wind.sp_50:=quantile(wind.sp,probs = 0.5,na.rm = TRUE), by=STATE]
station_averages[, atm.press_50:=quantile(atm.press,probs = 0.5,na.rm = TRUE), by=STATE]

station_averages
```

```
##       USAFID     temp  wind.sp atm.press      lat       lon temp_dist CTRY
##    1: 690150 33.18763 3.483560  1010.379 34.29982 -116.1658 9.5035752   US
##    2: 720110 31.22003 2.138348       NaN 30.78400  -98.6620 7.5359677   US
##    3: 720113 23.29317 2.470298       NaN 42.54300  -83.1780 0.3908894   US
##    4: 720120 27.01922 2.504692       NaN 32.21746  -80.6998 3.3351568   US
##    5: 720137 21.88823 1.979335       NaN 41.42500  -88.4190 1.7958292   US
##   ---                                                                     
## 1591: 726777 19.15492 4.673878  1014.299 46.35792 -104.2501 4.5291393   US
## 1592: 726797 18.78980 2.858586  1014.902 45.78795 -111.1600 4.8942607   US
## 1593: 726798 19.47014 4.445783  1014.072 45.69800 -110.4400 4.2139153   US
## 1594: 726810 25.03549 3.039794  1011.730 43.56700 -116.2390 1.3514356   US
## 1595: 726813 23.47809 2.435372  1012.315 43.64963 -116.6331 0.2059716   US
##       STATE  temp_50 wind.sp_50 atm.press_50
##    1:    CA 22.66268   2.565445     1012.557
##    2:    TX 29.75188   3.413737     1012.460
##    3:    MI 20.51970   2.273423     1014.927
##    4:    SC 25.80545   1.696119     1015.281
##    5:    IL 22.43194   2.237622     1014.760
##   ---                                       
## 1591:    MT 19.15492   4.151737     1014.185
## 1592:    MT 19.15492   4.151737     1014.185
## 1593:    MT 19.15492   4.151737     1014.185
## 1594:    ID 20.56798   2.568944     1012.855
## 1595:    ID 20.56798   2.568944     1012.855
```
Euclidean $\sqrt{\sum_i(x_i-y_i)^2}$

```r
station_averages[,eudist:=sqrt(
  (temp-temp_50)^2+(wind.sp-wind.sp_50)^2
)]
```

Find representitive for each state

```r
rep_state <- station_averages[ , .SD[which.min(eudist)], by = STATE]
rep_state
```

```
##     STATE USAFID     temp  wind.sp atm.press      lat        lon temp_dist CTRY
##  1:    CA 722970 22.76040 2.325982  1012.710 33.81264 -118.14652 0.9236572   US
##  2:    TX 722598 29.81293 3.521417       NaN 32.96900  -96.83600 6.1288732   US
##  3:    MI 725395 20.44096 2.357275  1015.245 42.26697  -84.46697 3.2431039   US
##  4:    SC 723107 25.95831 1.599275       NaN 33.58700  -80.20900 2.2742552   US
##  5:    IL 722076 22.34403 2.244115       NaN 40.19995  -87.59982 1.3400341   US
##  6:    MO 720479 24.14775 2.508153       NaN 36.90000  -94.01700 0.4636885   US
##  7:    AR 722054 26.58944 1.707136  1014.127 35.13500  -90.23400 2.9053841   US
##  8:    OR 720202 17.16329 1.828437       NaN 45.41700 -123.81700 6.5207664   US
##  9:    WA 720254 19.24684 1.268571       NaN 46.68276 -122.98300 4.4372238   US
## 10:    GA 722197 26.70404 1.544133  1015.574 33.35501  -84.56702 3.0199790   US
## 11:    MN 726553 19.67552 2.393582       NaN 44.96900  -95.71000 4.0085430   US
## 12:    AL 722286 26.35793 1.675828  1014.909 33.21200  -87.61600 2.6738730   US
## 13:    IN 724386 22.32575 2.243013  1014.797 40.41200  -86.93700 1.3583049   US
## 14:    NC 720864 24.82394 1.612864       NaN 35.93700  -77.54700 1.1398816   US
## 15:    VA 724006 24.31662 1.650539       NaN 36.66600  -76.32100 0.6325625   US
## 16:    IA 725464 21.37948 2.679227       NaN 41.67400  -93.02200 2.3045767   US
## 17:    PA 725204 21.87141 1.825605       NaN 40.76821  -80.39819 1.8126473   US
## 18:    NE 725565 21.86100 3.098367  1015.068 41.43378  -97.34964 1.8230630   US
## 19:    ID 725867 20.81272 2.702517  1012.802 42.54201 -113.76605 2.8713440   US
## 20:    WI 726413 18.94233 2.028610       NaN 43.41720  -88.13280 4.7417341   US
## 21:    WV 720328 21.94820 1.617823       NaN 39.00000  -80.27400 1.7358610   US
## 22:    MD 722218 24.89883 1.883499       NaN 38.53325  -76.03288 1.2147717   US
## 23:    AZ 722745 30.31538 3.307632  1010.144 32.16695 -110.88300 6.6313167   US
## 24:    OK 720625 27.06188 3.865717       NaN 36.75000  -97.35000 3.3778197   US
## 25:    WY 726654 19.85844 3.775443  1014.107 44.38100 -106.72100 3.8256192   US
## 26:    LA 722041 27.84758 1.476664       NaN 29.44500  -90.26100 4.1635250   US
## 27:    KY 720448 23.52994 1.604905       NaN 37.57800  -84.77000 0.1541178   US
## 28:    FL 722011 27.56952 2.674074  1016.063 28.29000  -81.43700 3.8854636   US
## 29:    CO 724699 21.94228 2.844072       NaN 39.90067 -105.11607 1.7417815   US
## 30:    OH 724295 21.97211 2.803524  1015.742 39.84000  -83.84000 1.7119534   US
## 31:    NJ 724090 23.47238 2.148606  1015.095 40.03300  -74.35016 0.2116829   US
## 32:    NM 723658 24.94447 3.569281  1013.917 36.74400 -108.22900 1.2604141   US
## 33:    KS 724550 24.14958 3.449278  1013.315 39.05022  -96.76687 0.4655163   US
## 34:    ND 720911 18.34248 3.940128       NaN 46.94196  -98.01800 5.3415810   US
## 35:    VT 726115 18.60548 1.101301  1014.985 43.34400  -72.51800 5.0785811   US
## 36:    MS 722358 26.54093 1.747426  1014.722 31.18298  -90.47100 2.8568706   US
## 37:    CT 725087 22.57539 2.126514  1014.534 41.73601  -72.65098 1.1086682   US
## 38:    NV 724885 24.78430 2.600266  1013.855 39.41700 -118.71577 1.1002416   US
## 39:    UT 725750 24.23571 3.040962  1011.521 41.19600 -112.01100 0.5516551   US
## 40:    SD 726590 19.95928 3.550722  1014.284 45.44377  -98.41344 3.7247800   US
## 41:    TN 720974 24.71645 1.483411       NaN 35.17800  -86.06600 1.0323860   US
## 42:    NY 724988 20.44142 2.394383  1016.233 42.57100  -77.71300 3.2426385   US
## 43:    RI 725079 22.27697 2.583469  1014.620 41.53300  -71.28300 1.4070879   US
## 44:    MA 725088 21.20391 2.773018  1013.718 42.58400  -70.91800 2.4801457   US
## 45:    DE 724180 24.56026 2.752929  1015.046 39.67400  -75.60600 0.8761984   US
## 46:    NH 726116 19.23920 1.465766  1013.840 43.62600  -72.30500 4.4448592   US
## 47:    ME 726077 18.49969 2.337241  1014.475 44.45000  -68.36677 5.1843701   US
## 48:    MT 726798 19.47014 4.445783  1014.072 45.69800 -110.44004 4.2139153   US
##     STATE USAFID     temp  wind.sp atm.press      lat        lon temp_dist CTRY
##      temp_50 wind.sp_50 atm.press_50     eudist
##  1: 22.66268   2.565445     1012.557 0.25863745
##  2: 29.75188   3.413737     1012.460 0.12378522
##  3: 20.51970   2.273423     1014.927 0.11503023
##  4: 25.80545   1.696119     1015.281 0.18095742
##  5: 22.43194   2.237622     1014.760 0.08815689
##  6: 23.95109   2.453547     1014.522 0.20409808
##  7: 26.24296   1.938625     1014.591 0.41669854
##  8: 17.98061   2.011436     1015.269 0.83755473
##  9: 19.24684   1.268571           NA 0.00000000
## 10: 26.70404   1.495596     1015.208 0.04853710
## 11: 19.63017   2.617071     1015.042 0.22804190
## 12: 26.33664   1.662132     1014.959 0.02531829
## 13: 22.25059   2.344333     1015.063 0.12615513
## 14: 24.72953   1.627306     1015.420 0.09550599
## 15: 24.37799   1.653032     1015.158 0.06141630
## 16: 21.33461   2.680875     1014.964 0.04490047
## 17: 21.69177   1.784167     1015.435 0.18435880
## 18: 21.87354   3.192539     1014.332 0.09500413
## 19: 20.56798   2.568944     1012.855 0.27881642
## 20: 18.85524   2.053283     1014.893 0.09051251
## 21: 21.94446   1.633487     1015.762 0.01610412
## 22: 24.89883   1.883499     1014.824 0.00000000
## 23: 30.32372   3.074359     1010.144 0.23342190
## 24: 27.14427   3.852697     1012.567 0.08341749
## 25: 19.80699   3.873392     1013.157 0.11063960
## 26: 27.87430   1.592840     1014.593 0.11920878
## 27: 23.88844   1.895486     1015.245 0.46147583
## 28: 27.57325   2.705069     1015.335 0.03121757
## 29: 21.49638   3.098777     1013.334 0.51351277
## 30: 22.02062   2.554397     1015.351 0.25380753
## 31: 23.47238   2.148606     1014.825 0.00000000
## 32: 24.94447   3.776083     1012.525 0.20680190
## 33: 24.21220   3.680613     1013.389 0.23966295
## 34: 18.52849   3.956459           NA 0.18672684
## 35: 18.61379   1.408247     1014.792 0.30705883
## 36: 26.69258   1.636392     1014.836 0.18795706
## 37: 22.36880   2.101801     1014.810 0.20806041
## 38: 24.56293   3.035050     1012.204 0.48789368
## 39: 24.35182   3.145427     1011.972 0.15618171
## 40: 20.35662   3.665638     1014.398 0.41362317
## 41: 24.88657   1.576035     1015.144 0.19370133
## 42: 20.40674   2.304075     1014.887 0.09673718
## 43: 22.53551   2.583469     1014.728 0.25853660
## 44: 21.30662   2.710944     1014.751 0.12000936
## 45: 24.56026   2.752929     1015.046 0.00000000
## 46: 19.55054   1.563826     1014.689 0.32641573
## 47: 18.79016   2.237210     1014.399 0.30721662
## 48: 19.15492   4.151737     1014.185 0.43107915
##      temp_50 wind.sp_50 atm.press_50     eudist
```
## Question 3: In the middle?

```r
midpoint <- met[, .(
  lon_50 = quantile(lon, probs = 0.5, na.rm = TRUE),
  lat_50 = quantile(lat, probs = 0.5, na.rm = TRUE)
), by = STATE]

station_averages <- merge(
  x = station_averages,
  y = midpoint,
  by = "STATE"
)
```


```r
station_averages[, mid_eudist:= sqrt(
  (lat - lat_50)^2+(lon - lon_50)^2
)]
station_averages
```

```
##       STATE USAFID     temp  wind.sp atm.press      lat       lon temp_dist
##    1:    AL 720265 26.22064 1.136691       NaN 32.91500  -85.9630 2.5365793
##    2:    AL 720307 25.14605 1.624349       NaN 34.86100  -86.5570 1.4619875
##    3:    AL 720361 26.62228 1.343410  1015.275 31.04299  -86.3120 2.9382239
##    4:    AL 720362 27.26504 1.746168  1014.559 31.84600  -86.6110 3.5809822
##    5:    AL 720376 24.97884 1.296044       NaN 34.22900  -86.2560 1.2947791
##   ---                                                                      
## 1591:    WY 726667 23.10219 3.290873  1012.276 44.51700 -108.0820 0.5818741
## 1592:    WY 726690 20.51681 4.242981  1013.000 41.80002 -107.2000 3.1672484
## 1593:    WY 726700 19.97665 3.066306  1015.219 44.51712 -109.0163 3.7074125
## 1594:    WY 726710 16.86569 3.500389  1014.944 42.58400 -110.1070 6.8183667
## 1595:    WY 726720 21.70287 3.800334  1012.771 43.06440 -108.4569 1.9811895
##       CTRY  temp_50 wind.sp_50 atm.press_50    eudist   lon_50 lat_50
##    1:   US 26.33664   1.662132     1014.959 0.5380938  -86.557 32.915
##    2:   US 26.33664   1.662132     1014.959 1.1911908  -86.557 32.915
##    3:   US 26.33664   1.662132     1014.959 0.4279917  -86.557 32.915
##    4:   US 26.33664   1.662132     1014.959 0.9321989  -86.557 32.915
##    5:   US 26.33664   1.662132     1014.959 1.4062861  -86.557 32.915
##   ---                                                                
## 1591:   US 19.80699   3.873392     1013.157 3.3462863 -108.389 42.796
## 1592:   US 19.80699   3.873392     1013.157 0.8002750 -108.389 42.796
## 1593:   US 19.80699   3.873392     1013.157 0.8247254 -108.389 42.796
## 1594:   US 19.80699   3.873392     1013.157 2.9648557 -108.389 42.796
## 1595:   US 19.80699   3.873392     1013.157 1.8972858 -108.389 42.796
##       mid_eudist
##    1:  0.5940000
##    2:  1.9460000
##    3:  1.8879695
##    4:  1.0703630
##    5:  1.3480345
##   ---           
## 1591:  1.7481667
## 1592:  1.5510301
## 1593:  1.8318759
## 1594:  1.7310356
## 1595:  0.2768643
```


```r
mid_state <- station_averages[ , .SD[which.min(mid_eudist)], by = STATE]
mid_state
```

```
##     STATE USAFID     temp   wind.sp atm.press      lat        lon    temp_dist
##  1:    AL 722300 26.61913 1.4962283  1014.860 33.17800  -86.78200  2.935070321
##  2:    AR 723429 26.41317 1.2792990  1013.768 35.25800  -93.09499  2.729115713
##  3:    AZ 723745 25.47964 1.9323676       NaN 34.25700 -111.33900  1.795578776
##  4:    CA 724815 26.37493 3.0223262  1011.292 37.28500 -120.51200  2.690874100
##  5:    CO 722061 13.63759 4.7152697       NaN 39.46713 -106.15000 10.046469305
##  6:    CT 720545 22.44858 1.8953103       NaN 41.38400  -72.50600  1.235482558
##  7:    DE 724088 24.72840 3.0324747  1014.860 39.13291  -75.46697  1.044341502
##  8:    FL 721042 26.76568 2.1262635       NaN 28.22800  -82.15600  3.081616442
##  9:    GA 722217 26.08577 1.1111361       NaN 32.56400  -82.98500  2.401706371
## 10:    IA 725466 21.79148 2.7225459       NaN 41.69100  -93.56600  1.892581446
## 11:    ID 726810 25.03549 3.0397936  1011.730 43.56700 -116.23903  1.351435647
## 12:    IL 724397 22.03413 3.4911565  1015.253 40.48271  -88.94836  1.649932249
## 13:    IN 720961 20.94252 2.0536596       NaN 40.71100  -86.37500  2.741535659
## 14:    KS 724509 23.67510 4.0668332  1013.863 38.06763  -97.27500  0.008959632
## 15:    KY 720448 23.52994 1.6049055       NaN 37.57800  -84.77000  0.154117766
## 16:    LA 720468 26.89874 1.1130356       NaN 30.55800  -92.09900  3.214682905
## 17:    MA 725068 20.83820 1.3823436  1014.377 41.87600  -71.02100  2.845858760
## 18:    MD 724060 25.19890 2.5318725  1014.701 39.17420  -76.68190  1.514845149
## 19:    ME 726185 19.62474 2.3867047  1014.475 44.31612  -69.79700  4.059319897
## 20:    MI 725405 19.91292 1.9441737       NaN 43.32200  -84.68800  3.771135505
## 21:    MN 726583 20.84136 2.0966314       NaN 45.14115  -94.50700  2.842700394
## 22:    MO 724453 22.13591 3.1443238  1014.957 38.70400  -93.18299  1.548144422
## 23:    MS 725023 26.91719 1.5542910       NaN 33.85718  -90.75800  3.233134714
## 24:    MT 726798 19.47014 4.4457831  1014.072 45.69800 -110.44004  4.213915349
## 25:    NC 722201 24.18637 0.9103853       NaN 35.58208  -79.10100  0.502306540
## 26:    ND 720867 18.20367 4.2037684       NaN 48.39000 -100.02400  5.480389509
## 27:    NE 725513 20.92713 3.1057502       NaN 40.89304  -97.99681  2.756925361
## 28:    NH 726050 19.86188 1.7327521  1014.487 43.20409  -71.50245  3.822183288
## 29:    NJ 724090 23.47238 2.1486061  1015.095 40.03300  -74.35016  0.211682876
## 30:    NM 722683 20.99638 3.2932303       NaN 33.45051 -105.51675  2.687675870
## 31:    NV 724770 21.37610 3.3832432  1012.475 39.60100 -116.00502  2.307963616
## 32:    NY 725150 18.89641 2.7945743  1015.606 42.20630  -75.98030  4.787651548
## 33:    OH 720928 21.87803 2.0763441       NaN 40.28000  -83.11500  1.806032328
## 34:    OK 723540 26.70174 4.1168113  1013.747 35.41690  -97.38319  3.017676124
## 35:    OR 725975 16.97502 2.0807921  1014.410 42.60000 -123.36400  6.709034748
## 36:    PA 725118 24.58627 2.0405376  1015.104 40.21700  -76.85100  0.902206861
## 37:    RI 725074 24.45822 4.7099462       NaN 41.59700  -71.41200  0.774161791
## 38:    SC 720603 26.32987 1.5150567       NaN 34.28300  -80.56700  2.645809723
## 39:    SD 726530 21.54663 3.3501799       NaN 43.76696  -99.31812  2.137431536
## 40:    TN 721031 24.36992 1.5135501       NaN 35.38000  -86.24600  0.685859466
## 41:    TX 722570 29.78121 3.5409697  1011.429 31.13371  -97.71700  6.097152888
## 42:    UT 724750 27.43966 6.7110071  1011.701 38.42650 -113.01225  3.755598747
## 43:    VA 720498 24.92926 2.0898389  1016.447 37.40000  -77.51700  1.245200026
## 44:    VT 726114 17.46999 1.1657614  1014.792 44.53400  -72.61400  6.214068914
## 45:    WA 720388 19.35326 0.5583820       NaN 47.10383 -122.28683  4.330800806
## 46:    WI 726465 16.59058 2.1990603       NaN 44.78246  -89.66700  7.093476632
## 47:    WV 720328 21.94820 1.6178231       NaN 39.00000  -80.27400  1.735861035
## 48:    WY 726720 21.70287 3.8003344  1012.771 43.06440 -108.45695  1.981189476
##     STATE USAFID     temp   wind.sp atm.press      lat        lon    temp_dist
##     CTRY  temp_50 wind.sp_50 atm.press_50     eudist   lon_50 lat_50
##  1:   US 26.33664   1.662132     1014.959 0.32760581  -86.557 32.915
##  2:   US 26.24296   1.938625     1014.591 0.68094353  -92.767 35.333
##  3:   US 30.32372   3.074359     1010.144 4.97687132 -111.733 34.257
##  4:   US 22.66268   2.565445     1012.557 3.74026733 -120.448 36.780
##  5:   US 21.49638   3.098777     1013.334 8.02332232 -105.861 39.217
##  6:   US 22.36880   2.101801     1014.810 0.22136389  -72.682 41.384
##  7:   US 24.56026   2.752929     1015.046 0.32621712  -75.467 39.133
##  8:   US 27.57325   2.705069     1015.335 0.99357192  -81.876 28.290
##  9:   US 26.70404   1.495596     1015.208 0.72805962  -83.270 32.564
## 10:   US 21.33461   2.680875     1014.964 0.45876192  -93.566 41.717
## 11:   US 20.56798   2.568944     1012.855 4.49226225 -116.240 43.650
## 12:   US 22.43194   2.237622     1014.760 1.31514478  -88.751 40.520
## 13:   US 22.25059   2.344333     1015.063 1.33997477  -86.296 40.711
## 14:   US 24.21220   3.680613     1013.389 0.66154934  -97.430 38.329
## 15:   US 23.88844   1.895486     1015.245 0.46147583  -84.672 37.591
## 16:   US 27.87430   1.592840     1014.593 1.08716469  -91.983 30.521
## 17:   US 21.30662   2.710944     1014.751 1.40875711  -70.918 42.098
## 18:   US 24.89883   1.883499     1014.824 0.71444576  -76.684 38.981
## 19:   US 18.79016   2.237210     1014.399 0.84785837  -69.667 44.316
## 20:   US 20.51970   2.273423     1014.927 0.69035006  -84.688 43.067
## 21:   US 19.63017   2.617071     1015.042 1.31826578  -94.382 45.097
## 22:   US 23.95109   2.453547     1014.522 1.94217233  -93.183 38.583
## 23:   US 26.69258   1.636392     1014.836 0.23914408  -90.078 33.433
## 24:   US 19.15492   4.151737     1014.185 0.43107915 -110.440 45.788
## 25:   US 24.72953   1.627306     1015.420 0.89944769  -79.101 35.633
## 26:   US 18.52849   3.956459           NA 0.40825256  -99.621 48.301
## 27:   US 21.87354   3.192539     1014.332 0.95037739  -98.054 41.189
## 28:   US 19.55054   1.563826     1014.689 0.35421350  -71.503 43.278
## 29:   US 23.47238   2.148606     1014.825 0.00000000  -74.417 40.277
## 30:   US 24.94447   3.776083     1012.525 3.97750690 -105.990 34.067
## 31:   US 24.56293   3.035050     1012.204 3.20580443 -116.891 39.300
## 32:   US 20.40674   2.304075     1014.887 1.58798840  -75.412 42.241
## 33:   US 22.02062   2.554397     1015.351 0.49886623  -83.078 40.333
## 34:   US 27.14427   3.852697     1012.567 0.51536090  -97.350 35.534
## 35:   US 17.98061   2.011436     1015.269 1.00797554 -123.364 42.600
## 36:   US 21.69177   1.784167     1015.435 2.90582697  -76.922 40.435
## 37:   US 22.53551   2.583469     1014.728 2.86683306  -71.433 41.597
## 38:   US 25.80545   1.696119     1015.281 0.55479393  -80.634 34.181
## 39:   US 20.35662   3.665638     1014.398 1.23111137  -99.318 44.045
## 40:   US 24.88657   1.576035     1015.144 0.52041208  -86.246 35.593
## 41:   US 29.75188   3.413737     1012.460 0.13057093  -97.691 31.178
## 42:   US 24.35182   3.145427     1011.972 4.71679162 -113.012 38.427
## 43:   US 24.37799   1.653032     1015.158 0.70334972  -77.558 37.321
## 44:   US 18.61379   1.408247     1014.792 1.16922105  -72.562 44.567
## 45:   US 19.24684   1.268571           NA 0.71811896 -122.416 47.104
## 46:   US 18.85524   2.053283     1014.893 2.26934476  -89.774 44.614
## 47:   US 21.94446   1.633487     1015.762 0.01610412  -80.400 38.885
## 48:   US 19.80699   3.873392     1013.157 1.89728577 -108.389 42.796
##     CTRY  temp_50 wind.sp_50 atm.press_50     eudist   lon_50 lat_50
##       mid_eudist
##  1: 3.461125e-01
##  2: 3.364586e-01
##  3: 3.940000e-01
##  4: 5.090396e-01
##  5: 3.822105e-01
##  6: 1.760000e-01
##  7: 9.971146e-05
##  8: 2.867821e-01
##  9: 2.850000e-01
## 10: 2.600000e-02
## 11: 8.300893e-02
## 12: 2.008532e-01
## 13: 7.900000e-02
## 14: 3.038729e-01
## 15: 9.885848e-02
## 16: 1.217580e-01
## 17: 2.447305e-01
## 18: 1.932160e-01
## 19: 1.300001e-01
## 20: 2.550000e-01
## 21: 1.325663e-01
## 22: 1.210028e-01
## 23: 8.014541e-01
## 24: 8.999539e-02
## 25: 5.091926e-02
## 26: 4.127106e-01
## 27: 3.014369e-01
## 28: 7.391191e-02
## 29: 2.529903e-01
## 30: 7.771935e-01
## 31: 9.357129e-01
## 32: 5.693602e-01
## 33: 6.463745e-02
## 34: 1.217095e-01
## 35: 0.000000e+00
## 36: 2.292706e-01
## 37: 2.100000e-02
## 38: 1.220369e-01
## 39: 2.780388e-01
## 40: 2.130000e-01
## 41: 5.135391e-02
## 42: 5.594700e-04
## 43: 8.900562e-02
## 44: 6.158633e-02
## 45: 1.291660e-01
## 46: 1.995685e-01
## 47: 1.705902e-01
## 48: 2.768643e-01
##       mid_eudist
```
merge data of median and mid stations

```r
rep_state[, type := "median station"]
mid_state[, type := "mid point"]
all_stations <- rbind(rep_state, mid_state, fill = TRUE)
```

draw the map

```r
library(leaflet)
```

```
## Warning: package 'leaflet' was built under R version 4.0.5
```

```r
pal <- colorFactor(c("red","blue"), domain = all_stations$type)
leaflet() %>% 
  addProviderTiles('CartoDB.Positron') %>% 
  addCircles(
    data = all_stations,
    lat = ~lat, lng = ~lon, 
    opacity = 1, fillOpacity = 1, radius = 400, color = ~pal(all_stations$type)
    ) %>%
  addLegend('bottomleft', pal=pal, values=all_stations$type,
          title='Sites', opacity=1)
```

```{=html}
<div id="htmlwidget-a71b0fa8403138247593" style="width:672px;height:480px;" class="leaflet html-widget"></div>
<script type="application/json" data-for="htmlwidget-a71b0fa8403138247593">{"x":{"options":{"crs":{"crsClass":"L.CRS.EPSG3857","code":null,"proj4def":null,"projectedBounds":null,"options":{}}},"calls":[{"method":"addProviderTiles","args":["CartoDB.Positron",null,null,{"errorTileUrl":"","noWrap":false,"detectRetina":false}]},{"method":"addCircles","args":[[33.8126445959104,32.969,42.2669724409449,33.587,40.1999540383757,36.9,35.135,45.417,46.6827613941019,33.3550061728395,44.969,33.212,40.412,35.937,36.666,41.674,40.7682093695778,41.4337808219178,42.5420088495575,43.4172000899281,39,38.5332464285714,32.1669504405286,36.75,44.381,29.445,37.578,28.29,39.90066615266,39.84,40.033,36.744,39.0502172096909,46.9419577656676,43.344,31.1829822852081,41.7360101010101,39.417,41.196,45.443765323993,35.178,42.571,41.5329991281604,42.584,39.6740047984645,43.626,44.45,45.6980046136102,33.1779980392157,35.2580031347962,34.257,37.285,39.4671277161863,41.384,39.1329054054054,28.228,32.564,41.691,43.5669967141292,40.4827108433735,40.711,38.0676310679612,37.578,30.558,41.876,39.1742046332046,44.3161194852941,43.322,45.1411456215152,38.7040028195489,33.8571800818554,45.6980046136102,35.5820807424594,48.39,40.8930385467435,43.2040901033973,40.033,33.4505100312082,39.6009961832061,42.206297648013,40.28,35.4169039487727,42.6,40.217,41.597,34.283,43.766961247216,35.38,31.1337142857143,38.4264995948136,37.4,44.5340018796992,47.1038340767172,44.7824594594595,39,43.0643970117396],[-118.146523855891,-96.836,-84.466968503937,-80.209,-87.5998161535029,-94.017,-90.234,-123.817,-122.983,-84.5670154320988,-95.71,-87.616,-86.937,-77.547,-76.321,-93.022,-80.3981859456333,-97.3496356164383,-113.766053097345,-88.1327999100719,-80.274,-76.0328767857143,-110.883,-97.35,-106.721002247191,-90.261,-84.77,-81.437,-105.116074016962,-83.84,-74.3501562130177,-108.229,-96.7668696741855,-98.018,-72.5179990974729,-90.4710035429584,-72.6509797979798,-118.715772727273,-112.01100124533,-98.413442206655,-86.066,-77.713,-71.2829991281604,-70.917996007984,-75.6060009596929,-72.3049961389961,-68.3667746192893,-110.440038062284,-86.7820019607843,-93.0949937304075,-111.339,-120.512002560819,-106.15,-72.506,-75.4669684684685,-82.156,-82.985,-93.566,-116.239031763417,-88.9483614457831,-86.375,-97.275,-84.77,-92.099,-71.021,-76.6819034749035,-69.797,-84.688,-94.507,-93.1829934210526,-90.758,-110.440038062284,-79.101,-100.024,-97.9968072662827,-71.5024542097489,-74.3501562130177,-105.516745430227,-116.005020356234,-75.980301703163,-83.115,-97.3831921024546,-123.364,-76.851,-71.412,-80.567,-99.3181162583519,-86.246,-97.717,-113.012250202593,-77.517,-72.614,-122.286834076717,-89.667,-80.274,-108.456947705443],400,null,null,{"interactive":true,"className":"","stroke":true,"color":["#FF0000","#FF0000","#FF0000","#FF0000","#FF0000","#FF0000","#FF0000","#FF0000","#FF0000","#FF0000","#FF0000","#FF0000","#FF0000","#FF0000","#FF0000","#FF0000","#FF0000","#FF0000","#FF0000","#FF0000","#FF0000","#FF0000","#FF0000","#FF0000","#FF0000","#FF0000","#FF0000","#FF0000","#FF0000","#FF0000","#FF0000","#FF0000","#FF0000","#FF0000","#FF0000","#FF0000","#FF0000","#FF0000","#FF0000","#FF0000","#FF0000","#FF0000","#FF0000","#FF0000","#FF0000","#FF0000","#FF0000","#FF0000","#0000FF","#0000FF","#0000FF","#0000FF","#0000FF","#0000FF","#0000FF","#0000FF","#0000FF","#0000FF","#0000FF","#0000FF","#0000FF","#0000FF","#0000FF","#0000FF","#0000FF","#0000FF","#0000FF","#0000FF","#0000FF","#0000FF","#0000FF","#0000FF","#0000FF","#0000FF","#0000FF","#0000FF","#0000FF","#0000FF","#0000FF","#0000FF","#0000FF","#0000FF","#0000FF","#0000FF","#0000FF","#0000FF","#0000FF","#0000FF","#0000FF","#0000FF","#0000FF","#0000FF","#0000FF","#0000FF","#0000FF","#0000FF"],"weight":5,"opacity":1,"fill":true,"fillColor":["#FF0000","#FF0000","#FF0000","#FF0000","#FF0000","#FF0000","#FF0000","#FF0000","#FF0000","#FF0000","#FF0000","#FF0000","#FF0000","#FF0000","#FF0000","#FF0000","#FF0000","#FF0000","#FF0000","#FF0000","#FF0000","#FF0000","#FF0000","#FF0000","#FF0000","#FF0000","#FF0000","#FF0000","#FF0000","#FF0000","#FF0000","#FF0000","#FF0000","#FF0000","#FF0000","#FF0000","#FF0000","#FF0000","#FF0000","#FF0000","#FF0000","#FF0000","#FF0000","#FF0000","#FF0000","#FF0000","#FF0000","#FF0000","#0000FF","#0000FF","#0000FF","#0000FF","#0000FF","#0000FF","#0000FF","#0000FF","#0000FF","#0000FF","#0000FF","#0000FF","#0000FF","#0000FF","#0000FF","#0000FF","#0000FF","#0000FF","#0000FF","#0000FF","#0000FF","#0000FF","#0000FF","#0000FF","#0000FF","#0000FF","#0000FF","#0000FF","#0000FF","#0000FF","#0000FF","#0000FF","#0000FF","#0000FF","#0000FF","#0000FF","#0000FF","#0000FF","#0000FF","#0000FF","#0000FF","#0000FF","#0000FF","#0000FF","#0000FF","#0000FF","#0000FF","#0000FF"],"fillOpacity":1},null,null,null,{"interactive":false,"permanent":false,"direction":"auto","opacity":1,"offset":[0,0],"textsize":"10px","textOnly":false,"className":"","sticky":true},null,null]},{"method":"addLegend","args":[{"colors":["#FF0000","#0000FF"],"labels":["median station","mid point"],"na_color":null,"na_label":"NA","opacity":1,"position":"bottomleft","type":"factor","title":"Sites","extra":null,"layerId":null,"className":"info legend","group":null}]}],"limits":{"lat":[28.228,48.39],"lng":[-123.817,-68.3667746192893]}},"evals":[],"jsHooks":[]}</script>
```

## Question 4: Means of means

```r
met[,state_temp:=mean(temp,na.rm = TRUE), by=STATE]
met[, state_wind.sp := mean(wind.sp, na.rm = TRUE),by = STATE]
met[, state_atm.press := mean(atm.press, na.rm = TRUE),by = STATE]
met[,temp_cat:=fifelse(state_temp<20,"low-temp",
                       fifelse(state_temp<25,"mid-temp",
                               "high-temp"))]
table(met$temp_cat,useNA = "always")
```

```
## 
## high-temp  low-temp  mid-temp      <NA> 
##    811126    430794   1135423         0
```
summarize

```r
tab <- met[, .(
  N_entries = .N,
  N_stations = length(unique(USAFID)),
  avg_temp = mean(state_temp),
  avg_wind.sp = mean(state_wind.sp),
  avg_atm.press = mean(state_atm.press)
), by = temp_cat]

knitr::kable(tab)
```



|temp_cat  | N_entries| N_stations| avg_temp| avg_wind.sp| avg_atm.press|
|:---------|---------:|----------:|--------:|-----------:|-------------:|
|mid-temp  |   1135423|        781| 22.39870|    2.352673|      1014.587|
|high-temp |    811126|        555| 27.74436|    2.512854|      1013.679|
|low-temp  |    430794|        259| 18.96402|    2.642823|            NA|





